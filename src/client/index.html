<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <style>
        .imageDiv {
            float: left;
        }
    </style>
</head>

<body>
    <h1>Hello</h1>
    <div>
        <input type="text" id="searchTextbox" />
        <button id="searchButton">Search</button>
        <button id="untaggedButton">Find untagged</button>
    </div>
    <div id="thumbnails"></div>
    <div style="clear: both">
        <button id="prevButton">Prev</button>
        <button id="nextButton">Next</button>
    </div>
    <div id="bigImage"></div>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js"></script>
    <script>
        var total, limit = 10, offset = 0;

        function getCookie(name) {
            var matches = document.cookie.match(new RegExp(
                "(?:^|; )" + name.replace(/([\.$?*|{}\(\)\[\]\\\/\+^])/g, '\\$1') + "=([^;]*)"
            ));
            return matches ? decodeURIComponent(matches[1]) : undefined;
        }

        function generateThumbnails(data) {
            total = data.total;
            limit = data.limit;
            offset = data.offset;
            $('#thumbnails').empty();
            $.each(data.items, function (index, value) {
                if (value.type === 'file') {
                    $('#thumbnails').prepend('<div class="imageDiv" data-name="' + value.name + '"><img class="imgPreview" src="' + value.preview + '"></img><input class="tagsInput" type="text" value="' + value.tags + '"/><button class="saveTagsBtn">Edit</button></div>');
                }
            });
        }

        function attachClickHandlers() {
            $('.imgPreview').click(function () {
                $('#bigImage').empty();
                var name = $(this).parent('.imageDiv').attr('data-name');

                $.get('/api/image?fileName=' + encodeURI(name))
                    .done(function (data) {
                        $('#bigImage').append('<img src="' + data.href + '"></img>');
                    })
                    .fail(function () {
                        console.error("Can't get full image");
                    });
            });

            $('.saveTagsBtn').click(function () {
                var name = $(this).parent('.imageDiv').attr('data-name');
                var tags = $(this).parent('.imageDiv').find('.tagsInput').val();

                $.post('/api/saveTags', { "name": name, "tags": tags });
            });
        }

        function getThumbnailsData(search, limit, offset) {
            $.get(`/api/preview?search=${encodeURI(search || '')}&limit=${limit}&offset=${offset}`)
                .done(function (data) {
                    generateThumbnails(data);
                    attachClickHandlers();
                })
                .fail(function () {
                    console.error("Can't get preview of images");
                });
        }

        function getThumbnailsDataWithUntagged(limit, offset) {
            $.ajax({
                url: `/api/untagged?limit=${limit}&offset=${offset}`,
                timeout: 600000
            }).done(function (data) {
                generateThumbnails(data);
                attachClickHandlers();
            })
            .fail(function () {
                console.error("Can't get preview of untagged images");
            });
        }

        $('#prevButton').click(function () {
            offset -= limit;
            if (offset < 0) {
                offset = 0;
            }
            getThumbnailsData($('#searchTextbox').val(), limit, offset);
        });

        $('#nextButton').click(function () {
            offset += limit;
            if (offset > total) {
                offset -= limit;
                if (offset < 0) {
                    offset = 0;
                }
            }
            getThumbnailsData($('#searchTextbox').val(), limit, offset);
        });

        $('#searchButton').click(function () {
            $('#bigImage').empty();
            offset = 0;
            getThumbnailsData($('#searchTextbox').val(), limit, offset);
        });

        $('#untaggedButton').click(function () {
            $('#bigImage').empty();
            offset = 0;
            getThumbnailsDataWithUntagged(limit, offset);
        });

        var token = getCookie("access_token");
        if (!token) {
            $.get('/api/clientId').then(function (clientId) {
                location.href = "https://oauth.yandex.ru/authorize?response_type=token&client_id=" + clientId;
            });
        } else {
            getThumbnailsData($('#searchTextbox').val(), limit, offset);
        }
    </script>
</body>

</html>